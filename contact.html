<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
      body { font-family: 'Roboto', sans-serif; padding: 15px; background-color: #f8f9fa; color: #3c4043; }
      
      /* Status Bar */
      #connection-status {
        font-size: 11px; text-align: center; padding: 5px; margin-bottom: 15px;
        background-color: #e8eaed; color: #5f6368; border-radius: 4px;
      }

      .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; }
      .header h2 { margin: 0; color: #1a73e8; font-size: 20px; }
      
      .form-group { margin-bottom: 15px; position: relative; } 
      label { display: block; font-weight: 500; font-size: 12px; margin-bottom: 4px; color: #5f6368; }
      input, textarea { width: 100%; padding: 10px; border: 1px solid #dadce0; border-radius: 4px; box-sizing: border-box; font-size: 14px; font-family: 'Roboto', sans-serif; }
      input:focus, textarea:focus { outline: none; border-color: #1a73e8; border-width: 2px; padding: 9px; }
      
      /* SUGEST√ïES DE BUSCA */
      .suggestions-box { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #dadce0; border-top: none; border-radius: 0 0 4px 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; max-height: 200px; overflow-y: auto; display: none; }
      .suggestion-item { padding: 10px; cursor: pointer; font-size: 13px; color: #202124; border-bottom: 1px solid #f1f3f4; }
      .suggestion-item:hover { background-color: #e8f0fe; color: #1a73e8; }
      
      /* BOT√ïES */
      .btn { border: none; padding: 12px; width: 100%; font-weight: bold; border-radius: 4px; cursor: pointer; font-size: 14px; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
      .btn:hover { opacity: 0.9; }
      .btn:active { transform: scale(0.98); }
      .btn-whatsapp { background-color: #25D366; margin-bottom: 20px; } 
      .btn-email { background-color: #ea4335; }
      
      .divider { display: flex; align-items: center; text-align: center; margin: 20px 0; color: #999; font-size: 12px; font-weight: bold; }
      .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid #dadce0; }
      .divider:not(:empty)::before { margin-right: .5em; }
      .divider:not(:empty)::after { margin-left: .5em; }
    </style>
  </head>
  <body>
    <!-- Diagn√≥stico Visual -->
    <div id="connection-status">üü° Iniciando sistema...</div>

    <div class="header">
      <h2><i class="far fa-comments"></i> Comunicador</h2>
    </div>

    <!-- BUSCA AUTOM√ÅTICA -->
    <div class="form-group">
      <label>üîç Buscar Cliente (Auto-Preencher)</label>
      <input type="text" id="inputBusca" placeholder="Aguarde..." autocomplete="off" oninput="filtrar()" onfocus="tentarRecarregar()">
      <div id="listaSugestoes" class="suggestions-box"></div>
    </div>

    <!-- √ÅREA WHATSAPP -->
    <div class="form-group">
      <label><i class="fab fa-whatsapp" style="color:#25D366"></i> WhatsApp</label>
      <input type="text" id="whatsTelefone" placeholder="(XX) 9XXXX-XXXX">
    </div>
    <div class="form-group">
      <textarea id="whatsMensagem" rows="2" placeholder="Mensagem..."></textarea>
    </div>
    <button type="button" class="btn btn-whatsapp" onclick="dispararWhatsapp()">
      <i class="fab fa-whatsapp"></i> ABRIR WHATSAPP
    </button>

    <div class="divider">OU EMAIL</div>

    <!-- √ÅREA EMAIL -->
    <div class="form-group">
      <label><i class="far fa-envelope" style="color:#ea4335"></i> E-mail</label>
      <input type="email" id="emailDestino" placeholder="cliente@email.com">
    </div>
    <div class="form-group">
      <input type="text" id="emailAssunto" placeholder="Assunto">
    </div>
    <div class="form-group">
      <textarea id="emailMensagem" rows="4" placeholder="Mensagem..."></textarea>
    </div>
    <button type="button" id="btnEmail" class="btn btn-email" onclick="dispararEmail()">
      <i class="fas fa-paper-plane"></i> ENVIAR EMAIL
    </button>

    <script>
      // --- C√âREBRO DO FRONT-END ---
      var leadsDB = []; // Banco de dados local
      var statusEl = document.getElementById('connection-status');

      // 1. Inicia carregamento assim que abre
      window.onload = function() {
        carregarDados();
      };

      function carregarDados() {
        statusEl.innerText = "üü° Conectando ao Sheets...";
        
        // Verifica se o Google existe (Modo Preview vs Real)
        if (typeof google === 'undefined') {
          statusEl.innerText = "‚ö†Ô∏è Modo Simula√ß√£o (Sem Google)";
          leadsDB = [{texto: "Teste | Empresa Fake", telefone: "11999999999", email: "teste@email.com"}];
          document.getElementById('inputBusca').placeholder = "Digite 'Teste'...";
          return;
        }

        google.script.run
          .withSuccessHandler(function(lista) {
            leadsDB = lista || [];
            statusEl.innerText = "‚úÖ " + leadsDB.length + " leads carregados.";
            statusEl.style.backgroundColor = "#d4edda";
            statusEl.style.color = "#155724";
            document.getElementById('inputBusca').placeholder = "Digite o nome...";
          })
          .withFailureHandler(function(erro) {
            statusEl.innerText = "‚ùå Erro: " + erro.message;
            statusEl.style.backgroundColor = "#f8d7da";
            statusEl.style.color = "#721c24";
          })
          .getListaLeads();
      }

      function tentarRecarregar() {
        if(leadsDB.length === 0) carregarDados();
      }

      // 2. L√≥gica de Filtro e Sele√ß√£o
      function normalizar(t) { return t ? t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : ""; }

      function filtrar() {
        var termo = normalizar(document.getElementById('inputBusca').value);
        var box = document.getElementById('listaSugestoes');
        box.innerHTML = '';

        if (termo.length < 1) { box.style.display = 'none'; return; }

        var resultados = leadsDB.filter(function(lead) {
          return normalizar(lead.texto).indexOf(termo) > -1;
        });

        if (resultados.length === 0) {
          box.style.display = 'none';
          return;
        }

        resultados.slice(0, 5).forEach(function(lead) {
          var div = document.createElement('div');
          div.className = 'suggestion-item';
          div.innerHTML = 'üîç ' + lead.texto;
          
          // O PULO DO GATO: Preenchimento Autom√°tico ao Clicar
          div.onclick = function() {
            document.getElementById('inputBusca').value = lead.texto.split('|')[0].trim();
            
            // PREENCHE TELEFONE E EMAIL AUTOMATICAMENTE
            document.getElementById('whatsTelefone').value = lead.telefone || "";
            document.getElementById('emailDestino').value = lead.email || "";
            
            box.style.display = 'none';
            statusEl.innerText = "‚úÖ Dados preenchidos!";
          };
          
          box.appendChild(div);
        });
        box.style.display = 'block';
      }

      // 3. A√ß√£o do WhatsApp (Limpeza e Disparo)
      function dispararWhatsapp() {
        var fone = document.getElementById('whatsTelefone').value;
        var msg = document.getElementById('whatsMensagem').value;

        if (!fone) { alert("Erro: Campo de telefone vazio!"); return; }

        // Limpa tudo que n√£o for n√∫mero
        var foneLimpo = fone.replace(/\D/g, '');
        
        // Corrige DDI Brasil se necess√°rio (se tiver 10 ou 11 d√≠gitos, assume 55)
        if (foneLimpo.length >= 10 && foneLimpo.length <= 11) {
          foneLimpo = "55" + foneLimpo;
        }

        var url = "https://wa.me/" + foneLimpo + "?text=" + encodeURIComponent(msg);
        
        // Abre nova aba
        window.open(url, '_blank');
      }

      // 4. A√ß√£o de E-mail
      function dispararEmail() {
        if (typeof google === 'undefined') { alert("Simula√ß√£o: Email enviado!"); return; }

        var btn = document.getElementById('btnEmail');
        var dest = document.getElementById('emailDestino').value;
        var ass = document.getElementById('emailAssunto').value;
        var msg = document.getElementById('emailMensagem').value;

        if (!dest || !ass || !msg) { alert("Preencha todos os campos de e-mail!"); return; }

        btn.disabled = true;
        btn.innerText = "Enviando...";

        google.script.run
          .withSuccessHandler(function(res) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> ENVIAR EMAIL';
            alert(res);
            // Limpa campos de texto, mant√©m email
            document.getElementById('emailAssunto').value = "";
            document.getElementById('emailMensagem').value = "";
          })
          .withFailureHandler(function(erro) {
            alert("Erro: " + erro.message);
            btn.disabled = false;
            btn.innerText = "TENTAR NOVAMENTE";
          })
          .enviarEmailLead(dest, ass, msg);
      }
      
      // Fecha sugest√µes ao clicar fora
      document.addEventListener('click', function(e) {
        if (e.target.id !== 'inputBusca') {
          document.getElementById('listaSugestoes').style.display = 'none';
        }
      });
    </script>
  </body>
</html>