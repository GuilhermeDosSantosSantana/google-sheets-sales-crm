<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
      body { font-family: 'Roboto', sans-serif; padding: 15px; background-color: #f8f9fa; color: #3c4043; }
      #system-status { background-color: #fff3cd; color: #856404; padding: 8px; font-size: 11px; text-align: center; border-radius: 4px; margin-bottom: 15px; border: 1px solid #ffeeba; display: none; }
      .tabs { display: flex; border-bottom: 2px solid #dadce0; margin-bottom: 15px; }
      .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; font-weight: 500; color: #5f6368; border-bottom: 2px solid transparent; transition: all 0.2s; font-size: 13px; user-select: none; }
      .tab:hover { color: #188038; background: #e8f5e9; }
      .tab.active { color: #188038; border-bottom: 2px solid #188038; font-weight: bold; }
      .tab-content { display: none; }
      .tab-content.active { display: block; animation: fadeIn 0.3s; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      .form-group { margin-bottom: 12px; position: relative; } 
      label { display: block; font-weight: 500; font-size: 12px; margin-bottom: 4px; color: #5f6368; }
      input, select, textarea { width: 100%; padding: 8px; border: 1px solid #dadce0; border-radius: 4px; box-sizing: border-box; font-size: 14px; font-family: 'Roboto', sans-serif; }
      input:focus, select:focus, textarea:focus { outline: none; border-color: #1a73e8; border-width: 2px; padding: 7px; }
      .suggestions-box { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #dadce0; border-top: none; border-radius: 0 0 4px 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; max-height: 200px; overflow-y: auto; display: none; }
      .suggestion-item { padding: 10px; cursor: pointer; font-size: 13px; color: #202124; border-bottom: 1px solid #f1f3f4; display: flex; align-items: center; }
      .suggestion-item:last-child { border-bottom: none; }
      .suggestion-item:hover { background-color: #e8f0fe; color: #1a73e8; }
      .btn { border: none; padding: 10px; width: 100%; font-weight: bold; border-radius: 4px; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: opacity 0.2s; }
      .btn:hover { opacity: 0.9; }
      .btn:disabled { background-color: #ccc !important; cursor: not-allowed; }
      .btn-primary { background-color: #1a73e8; color: white; padding: 12px; font-size: 14px; text-transform: uppercase; margin-bottom: 15px; }
      .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
      .btn-secondary { background-color: #f1f3f4; color: #3c4043; border: 1px solid #dadce0; font-weight: 500; font-size: 11px; }
      .btn-secondary:hover { background-color: #e8eaed; }
      .btn-save { background-color: #188038; color: white; margin-top: 10px; } 
      .btn-manage { background-color: #fff; color: #5f6368; border: 1px solid #dadce0; margin-top: 5px; }
      .btn-manage:hover { background-color: #f8f9fa; border-color: #1a73e8; }
      .divider { margin: 25px 0 15px 0; border-top: 1px solid #dadce0; text-align: center; position: relative; }
      .divider span { background-color: #f8f9fa; padding: 0 10px; color: #5f6368; font-size: 12px; position: relative; top: -8px; font-weight: 500; }
    </style>
  </head>
  <body>
    <!-- NAVEGAÃ‡ÃƒO -->
    <div class="tabs">
      <div id="tab-btn-cadastro" class="tab active" onclick="switchTab(this, 'cadastro')">ğŸ“ Novo Lead</div>
      <div id="tab-btn-update" class="tab" onclick="switchTab(this, 'update')">ğŸ”„ Atualizar</div>
    </div>

    <!-- ABA 1: CADASTRO -->
    <div id="content-cadastro" class="tab-content active">
      <form id="leadForm" onsubmit="handleFormSubmit(this)">
        <div class="form-group"><label>Nome do Contato *</label><input type="text" name="nome" required placeholder="Ex: JoÃ£o Silva"></div>
        <div class="form-group"><label>Nome da Empresa *</label><input type="text" name="empresa" required placeholder="Ex: Padaria Central"></div>
        <div class="form-group"><label>Telefone</label><input type="text" name="telefone" placeholder="(XX) 9XXXX-XXXX"></div>
        
        <!-- CATEGORIA EXPANDIDA E ORGANIZADA -->
        <div class="form-group"><label>ğŸ·ï¸ Categoria (Nicho)</label>
          <select name="categoria">
            <option value="">-- Selecione --</option>
            <optgroup label="Alto Valor & ServiÃ§os">
              <option value="Advocacia">âš–ï¸ Advocacia</option>
              <option value="Arquitetura & Interiores">ğŸ›ï¸ Arquitetura & Interiores</option>
              <option value="Contabilidade">ğŸ“‰ Contabilidade</option>
              <option value="Consultoria Financeira">ğŸ’° Consultoria Financeira</option>
              <option value="Corretoras de Seguros">ğŸ›¡ï¸ Corretoras de Seguros</option>
              <option value="Energia Solar">â˜€ï¸ Energia Solar</option>
              <option value="ImÃ³veis">ğŸ  ImÃ³veis (Alto PadrÃ£o)</option>
            </optgroup>
            <optgroup label="SaÃºde & EstÃ©tica">
              <option value="HarmonizaÃ§Ã£o">ğŸ’‰ HarmonizaÃ§Ã£o</option>
              <option value="Odonto Premium">ğŸ¦· Odonto Premium</option>
              <option value="MÃ©dicos Especialistas">ğŸ©º MÃ©dicos Especialistas</option>
              <option value="FarmÃ¡cias de ManipulaÃ§Ã£o">ğŸ’Š FarmÃ¡cias de ManipulaÃ§Ã£o</option>
              <option value="Ã“ticas">ğŸ‘“ Ã“ticas</option>
              <option value="Beleza Express">ğŸ’… Beleza Express</option>
              <option value="Barbearia">ğŸ’ˆ Barbearia</option>
              <option value="Fitness">ğŸ’ª Fitness</option>
            </optgroup>
            <optgroup label="ComÃ©rcio & Varejo">
              <option value="Revenda de Carros">ğŸš— Revenda de Carros</option>
              <option value="Moda">ğŸ‘— Moda</option>
              <option value="Mercados">ğŸ›’ Mercados</option>
              <option value="Lojas Locais">ğŸ›ï¸ Lojas Locais</option>
              <option value="Pet">ğŸ¾ Pet</option>
            </optgroup>
            <optgroup label="ServiÃ§os & Lazer">
              <option value="Gastronomia">ğŸ” Gastronomia</option>
              <option value="Delivery de Nicho">ğŸ›µ Delivery de Nicho</option>
              <option value="Eventos & Festas">ğŸ‰ Eventos & Festas</option>
              <option value="Turismo & Viagens">âœˆï¸ Turismo & Viagens</option>
              <option value="EducaÃ§Ã£o">ğŸ“ EducaÃ§Ã£o</option>
              <option value="EstÃ©tica Automotiva">ğŸ§¼ EstÃ©tica Automotiva</option>
              <option value="Oficinas MecÃ¢nicas">ğŸ”§ Oficinas MecÃ¢nicas</option>
              <option value="ServiÃ§os Casa">ğŸ› ï¸ ServiÃ§os Casa</option>
              <option value="Tatuagem & Piercing">âœ’ï¸ Tatuagem & Piercing</option>
            </optgroup>
            <option value="Outros">ğŸŒ Outros</option>
          </select>
        </div>

        <div class="form-group"><label>E-mail</label><input type="email" name="email"></div>
        <div class="form-group"><label>Estado (UF)</label><input type="text" name="cidadeEstado"></div>
        <div class="form-group"><label>AnotaÃ§Ã£o</label><textarea name="oQuePrecisa" rows="2"></textarea></div>
        <div class="form-group"><label>Valor (R$)</label><input type="text" name="valor"></div>
        
        <div class="form-group"><label>Fonte</label>
          <select name="fonte">
            <option value="ProspecÃ§Ã£o Ativa">ProspecÃ§Ã£o Ativa</option>
            <option value="IndicaÃ§Ã£o">IndicaÃ§Ã£o</option>
            <option value="Instagram">Instagram</option>
            <option value="Facebook">Facebook</option>
            <option value="Google Ads">Google Ads</option>
            <option value="Google Meu NegÃ³cio">Google Meu NegÃ³cio</option>
            <option value="Outros">Outros</option>
          </select>
        </div>
        <div class="form-group"><label>PrÃ³ximo Passo</label><input type="text" name="proximoPasso" value="Ligar"></div>
        <div class="form-group"><label>Link Instagram</label><input type="text" name="linkInstagram"></div>
        <div class="form-group"><label>Link Maps</label><input type="text" name="linkGmb"></div>
        <button type="submit" id="btnSalvar" class="btn btn-save">ğŸ’¾ SALVAR</button>
      </form>
    </div>

    <!-- ABA 2: ATUALIZAÃ‡ÃƒO -->
    <div id="content-update" class="tab-content">
      <div style="text-align: center; margin-bottom: 15px; color: #5f6368; font-size: 13px;">Busque e selecione para editar.</div>
      <div class="form-group">
        <label>ğŸ” Pesquisar Lead</label>
        <input type="text" id="inputBuscaLead" placeholder="Nome ou empresa..." autocomplete="off" oninput="filtrarSugestoes('update')" onfocus="iniciarCargaDeDados()">
        <div id="boxSugestoesUpdate" class="suggestions-box"></div>
        <input type="hidden" id="idLeadSelecionado">
      </div>
      
      <div class="form-group"><label>ğŸ“Š Status</label>
        <select id="novoStatus">
          <option value="">-- Selecione --</option>
          <option value="ProspecÃ§Ã£o">ğŸŸ¢ ProspecÃ§Ã£o</option>
          <option value="Contato Feito">ğŸ“ Contato Feito</option>
          <option value="Em NegociaÃ§Ã£o">ğŸ¤ Em NegociaÃ§Ã£o</option>
          <option value="Ganho">ğŸ† Ganho</option>
          <option value="Perdido">âŒ Perdido</option>
        </select>
      </div>
      <div class="form-group"><label>ğŸ‘£ PrÃ³ximo Passo</label><input type="text" id="inputProximoPassoUpdate"></div>
      <div class="form-group"><label>ğŸ“… Data (Vazio = Agora)</label><input type="datetime-local" id="dataInteracao"></div>
      
      <button type="button" class="btn btn-primary" onclick="atualizarLead('tudo')"><i class="fas fa-rocket"></i> Atualizar Tudo</button>
      <div class="action-grid">
        <button type="button" class="btn btn-secondary" onclick="atualizarLead('status')">ğŸ“Š Apenas Status</button>
        <button type="button" class="btn btn-secondary" onclick="atualizarLead('proxPasso')">ğŸ‘£ Apenas PrÃ³x. Passo</button>
      </div>
      <button type="button" class="btn btn-secondary" style="width: 100%; margin-top: 0;" onclick="atualizarLead('data')">ğŸ“… Registrar Apenas Data</button>
      <div id="msgUpdate" style="display:none; color:#e37400; text-align:center; margin-top:10px;">Atualizado!</div>
    </div>

    <!-- GESTÃƒO -->
    <div class="divider"><span>âš™ï¸ GESTÃƒO</span></div>
    <button type="button" id="btnOrganizar" class="btn btn-manage" onclick="organizarTabela()">ğŸ§¹ Organizar por Status</button>
    <button type="button" id="btnProcessar" class="btn btn-manage" onclick="processarFechamento()">ğŸ“¥ Processar Fechamento</button>

    <script>
      function switchTab(clickedTab, tabName) {
        try {
          var contents = document.querySelectorAll('.tab-content');
          contents.forEach(function(el) { el.classList.remove('active'); });
          var tabs = document.querySelectorAll('.tab');
          tabs.forEach(function(el) { el.classList.remove('active'); });
          
          document.getElementById('content-' + tabName).classList.add('active');
          if(clickedTab) clickedTab.classList.add('active');
          
          if(tabName !== 'cadastro') { setTimeout(function() { try { iniciarCargaDeDados(); } catch(e) {} }, 10); }
        } catch(e) { console.error("Erro abas:", e); }
      }

      function handleFormSubmit(formObject) {
        if (typeof google === 'undefined') { alert("Modo SimulaÃ§Ã£o: Salvo!"); return; }
        event.preventDefault(); 
        const btn = document.getElementById('btnSalvar'); 
        btn.disabled = true; btn.textContent = "Salvando...";
        
        const dados = {
          nome: formObject.nome.value, empresa: formObject.empresa.value, email: formObject.email.value,
          telefone: formObject.telefone.value, cidadeEstado: formObject.cidadeEstado.value,
          oQuePrecisa: formObject.oQuePrecisa.value, valor: formObject.valor.value, fonte: formObject.fonte.value,
          proximoPasso: formObject.proximoPasso.value, linkGmb: formObject.linkGmb.value,
          linkInstagram: formObject.linkInstagram.value,
          categoria: formObject.categoria.value 
        };
        google.script.run.withSuccessHandler(() => {
          document.getElementById('leadForm').reset(); btn.disabled = false; btn.textContent = "ğŸ’¾ SALVAR";
          alert("Lead salvo com sucesso!");
        }).withFailureHandler((erro) => { alert("Erro: " + erro.message); btn.disabled = false; btn.textContent = "TENTAR"; }).processarFormulario(dados);
      }

      let leadsCarregados = []; let dadosCarregados = false; 
      function iniciarCargaDeDados() {
        if (dadosCarregados) return;
        if (typeof google === 'undefined') { leadsCarregados = [{id:1, texto:"Teste", statusAtual:"ProspecÃ§Ã£o"}]; dadosCarregados = true; return; }
        const inputUpdate = document.getElementById('inputBuscaLead');
        if(inputUpdate) inputUpdate.placeholder = "A conectar...";
        google.script.run.withSuccessHandler((lista) => {
            leadsCarregados = lista || []; dadosCarregados = true;
            if(inputUpdate) inputUpdate.placeholder = "Nome ou empresa...";
          }).withFailureHandler((erro) => { console.error("Falha Google:", erro); }).getListaLeads();
      }
      
      function forcarRecarga() { dadosCarregados = false; iniciarCargaDeDados(); }
      function normalizar(texto) { return texto ? texto.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : ""; }

      function filtrarSugestoes(modo) {
        const input = document.getElementById('inputBuscaLead');
        const box = document.getElementById('boxSugestoesUpdate');
        const termo = normalizar(input.value);
        box.innerHTML = ''; 
        if (termo.length < 1) { box.style.display = 'none'; return; }
        if (!dadosCarregados) { iniciarCargaDeDados(); return; } 
        const sugestoes = leadsCarregados.filter(lead => normalizar(lead.texto).includes(termo));
        if (sugestoes.length === 0) { box.innerHTML = '<div style="padding:10px;font-size:12px;color:#5f6368;">âŒ Nada encontrado.</div>'; box.style.display = 'block'; return; }
        sugestoes.slice(0, 5).forEach(lead => { 
          const div = document.createElement('div');
          div.className = 'suggestion-item';
          div.innerHTML = `<span>ğŸ” ${lead.texto.split('|')[0]} </span> <span style="font-size:11px; color:#999;">${lead.texto.split('|')[1] || ''}</span>`;
          div.onclick = function() { selecionarLeadUpdate(lead); };
          box.appendChild(div);
        });
        box.style.display = 'block';
      }

      function selecionarLeadUpdate(lead) {
        const input = document.getElementById('inputBuscaLead');
        const box = document.getElementById('boxSugestoesUpdate');
        const selectStatus = document.getElementById('novoStatus');
        const inputProxPasso = document.getElementById('inputProximoPassoUpdate');
        const idField = document.getElementById('idLeadSelecionado');
        input.value = lead.texto.split('|')[0].trim();
        selectStatus.value = lead.statusAtual;
        inputProxPasso.value = lead.proxPasso || ""; 
        idField.value = lead.id;
        box.style.display = 'none';
      }

      function atualizarLead(tipoAcao) {
        if (typeof google === 'undefined') { alert("Modo SimulaÃ§Ã£o: Atualizado!"); return; }
        let idLead = document.getElementById('idLeadSelecionado').value;
        const selectStatus = document.getElementById('novoStatus');
        const inputProxPasso = document.getElementById('inputProximoPassoUpdate');
        const dataInput = document.getElementById('dataInteracao');
        const msg = document.getElementById('msgUpdate');
        
        if (!idLead) { alert("Selecione um lead da lista."); return; }
        
        const botoes = document.querySelectorAll('.btn');
        botoes.forEach(b => b.disabled = true);
        
        let statusParaEnviar = null;
        let proxPassoParaEnviar = null;
        const dataParaEnviar = dataInput.value; 

        if (tipoAcao === 'tudo') {
            statusParaEnviar = selectStatus.value;
            proxPassoParaEnviar = inputProxPasso.value;
        } else if (tipoAcao === 'status') {
            statusParaEnviar = selectStatus.value;
        } else if (tipoAcao === 'proxPasso') {
            proxPassoParaEnviar = inputProxPasso.value;
        } 

        google.script.run.withSuccessHandler((res) => {
            botoes.forEach(b => b.disabled = false);
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
            dadosCarregados = false; iniciarCargaDeDados();
          })
          .withFailureHandler((erro) => { alert("Erro: " + erro.message); botoes.forEach(b => b.disabled = false); })
          .atualizarStatusLead(idLead, statusParaEnviar, dataParaEnviar, proxPassoParaEnviar);
      }

      function organizarTabela() {
        if (typeof google === 'undefined') { alert("Modo SimulaÃ§Ã£o: Organizado!"); return; }
        const btn = document.getElementById('btnOrganizar'); 
        const txt = btn.textContent; btn.disabled = true; btn.textContent = "...";
        google.script.run.withSuccessHandler(() => { btn.disabled = false; btn.textContent = txt; }).withFailureHandler(() => { btn.disabled = false; btn.textContent = txt; }).organizarPorStatus();
      }
      function processarFechamento() {
        if (typeof google === 'undefined') { alert("Modo SimulaÃ§Ã£o: Fechado!"); return; }
        const btn = document.getElementById('btnProcessar'); const txt = btn.textContent; btn.disabled = true; btn.textContent = "...";
        google.script.run.withSuccessHandler(() => { btn.disabled = false; btn.textContent = txt; alert("ConcluÃ­do!"); }).withFailureHandler(() => { btn.disabled = false; btn.textContent = txt; }).moverLeadsFinalizados();
      }
    </script>
  </body>
</html>